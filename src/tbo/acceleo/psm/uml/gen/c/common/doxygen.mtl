[comment encoding = UTF-8 /]
[module doxygen('http://www.eclipse.org/uml2/5.0.0/UML')]

[import tbo::acceleo::psm::uml::gen::c::common::utils/]
[import tbo::acceleo::psm::uml::gen::c::request::request/]

[**
 * Get the operation parameter doxygen documentation header.
 * @param aParameter Parameter that should be documented.
 */]
[query private doxygen_param(aParameter : Parameter) : String = 
      doxygen_param(aParameter.direction, aParameter.name)/]

[**
 * Get the operation parameter doxygen documentation header.
 * @param aParameter Parameter that should be documented.
 */]
[query public doxygen_param(aDirection : ParameterDirectionKind,
                            aName : String) : String = 
      '@param ' + doxygen_param_dir(aDirection) + ' ' + aName + ' '/]

[query public doxygen_return(aString : String) : String = 
      '@return ' + aString/]

[**
 * Get the doxygen specification of the operation parameter direction. 
 */]
[query private doxygen_param_dir(aDirection : ParameterDirectionKind) : String
 = '[' + if (aDirection = ParameterDirectionKind::inout)
         then 'in,out' else aDirection endif + ']' /]

[query private doxygen_brief (aString : String) : String = 
'@brief ' + aString + utils_newline()/]

[query private doxygen_file (aString : String) : String = 
'@file ' + aString/]

[query private doxygen_line_prefix(aString : String) : String = 
  ' * ' + aString /]

[**
 * @brief Follows each newline symbol with a prefix string.
 * @param aString The string in which the newlines should be replaced.
 * @param line_prefix The string that should be inserted after each line 
 *     separator. 
 */]
[query private doxygen_newlines(aString : String, line_prefix : String) : 
  String = indent_newlines(aString, line_prefix.doxygen_line_prefix())/]

[**
 * Splits a long doxygen documentation block line into multiple shorter lines.
*/]
[query private doxygen_split_a_long_line(aString : String, line_width: Integer,
                                        prefix : String)
     : String = let doxygen_prefix_length : Integer 
                    = prefix.doxygen_line_prefix().size() in
     if  aString.size() > doxygen_prefix_length then
       if aString.size() > line_width then
         let last_space : Integer = 
             request_last_whitespace_index(aString,line_width) in
         if last_space > doxygen_prefix_length 
            and (not Set{' ','\t'}->includes(
                  aString.at(doxygen_prefix_length + 1))) 
         then
           aString.first(last_space-1) + utils_newline() 
           + (prefix.doxygen_line_prefix()
              + aString.substring(last_space + 1))
               .doxygen_split_a_long_line(line_width, prefix)
         else
           aString.first(line_width-3)+'...' + utils_newline() 
           + (prefix.doxygen_line_prefix() + '...'
              + aString.substring(line_width-2))
               .doxygen_split_a_long_line(line_width, prefix)
         endif
       else
         aString
       endif
     else aString endif/]

[**
 * Splits long lines in a doxygen documentation block into shorter ones.
 */]
[query private doxygen_split_long_lines(aString : String, line_width: Integer,
                                        prefix : String)
     : String = let doxygen_prefix_length : Integer 
                    = prefix.doxygen_line_prefix().size() in
     if  aString.size() > doxygen_prefix_length then
       let line_length : Integer = aString.index(utils_newline()) in
       if line_length > 0 then
         aString.first(line_length-1).doxygen_split_a_long_line(line_width, 
                                                                prefix)
         + utils_newline() + 
         if (line_length + utils_newline().size()) < aString.size() then
           aString.substring(line_length + utils_newline().size())
           .doxygen_split_long_lines(line_width, prefix)
         else '' endif
       else
         aString.doxygen_split_a_long_line(line_width, prefix)
       endif
     else aString endif/]

[template private doxygen_block(aString : String)]
/**
[aString/] */
[/template]

[**
 * Concatenates the element's comments with additional prefix into a 
 * documentation block.  
 * @param anElement The element that should be commented.
 * @param before_comments The text that should be inserted before the first 
 * comment.
 */]
[template private doxygen_comments(anElement : Element,
                     before_comments : String, line_width : Integer)
                     post(doxygen_split_long_lines(line_width, 
                       utils_get_indent_string().first(before_comments.size())))
                     {before_comments_prefixed : String 
                        = before_comments.doxygen_line_prefix();
                      seqComments : Sequence(Comment) 
                        = anElement.ancestors()->prepend(anElement)
                        ->last().eAllContents(Comment)
                        ->select(aComment : Comment 
                            | aComment.annotatedElement->includes(anElement));
                      spaces : String = 
                        utils_get_indent_string().first(before_comments.size());
                      b_is_not_empty : Boolean = 
                                (before_comments.size()>0) 
                                 or (not seqComments->isEmpty());}]
[if (b_is_not_empty)
][before_comments_prefixed
/][/if][for (aComment: Comment | seqComments)
                       separator(utils_newline()+ spaces.doxygen_line_prefix())
][aComment._body.doxygen_newlines(spaces)/][/for][if (b_is_not_empty)
][utils_newline()/][/if]
[/template]

[**
 * Inserts a string into a separate doxygen documentation block.
 * @param aString The string to be inserted in the documentation block.
 * @param line_width The line width of the documentation block.
*/]
[template public doxygen_doc_block_string(aString:String, line_width : Integer) 
                                                     post(doxygen_block())]
[aString.doxygen_line_prefix().doxygen_newlines('')
 .doxygen_split_long_lines(line_width, '')/]

[/template]
[**
 * @brief The template that generates doxygen documentation 
 * for the given object.
 */]
[template public doxygen_documentation(anElement: Element, line_width : Integer) 
                                                    post(doxygen_block())]
[doxygen_comments(anElement,'',line_width)
/][let anOp : Operation = if anElement.oclIsKindOf(Behavior) then 
               anElement.oclAsType(Behavior).specification else anElement endif]
[if (not anOp.isStatic)]
[doxygen_param(ParameterDirectionKind::_in, 
               utils_get_self_name()).doxygen_line_prefix()
/]The pointer to the self object.
[/if]
[for (aParameter : Parameter | 
                      request_parameter_only(anOp.ownedParameter))
][doxygen_comments(aParameter, doxygen_param(aParameter),line_width)
/][/for][if (not anOp.type.oclIsUndefined())]
[doxygen_comments(
   request_return_value(anOp.ownedParameter)->first(),
   doxygen_return(''),line_width)/][/if]
[else]
[if anElement.oclIsKindOf(Behavior) 
    and (not anElement.oclAsType(Behavior).owner.oclIsUndefined())
    and anElement.oclAsType(Behavior).owner.oclIsKindOf(State)]
[doxygen_param(ParameterDirectionKind::_in, 
               utils_get_self_name()).doxygen_line_prefix()
/]The pointer to the self object.
[/if]
[/let]
[/template]

[**
 * @brief The template for doxygen documentation of a header file. 
 */]
[template public doxygen_header_doc(anElement: Element, line_width : Integer)
                             post(doxygen_block())]
[doxygen_file('').doxygen_line_prefix()/]
[doxygen_line_prefix('')/]
[doxygen_comments(anElement,'',line_width)/]
[/template]

[**
 * @brief The template for doxygen documentation of a header file using a 
 * specific string. 
 */]
[template public doxygen_header_doc_string(str: String, line_width : Integer)
                             post(doxygen_block())]
[doxygen_file('').doxygen_line_prefix()/]
[doxygen_line_prefix('')/]
[if (str.size()>0)]
[str.doxygen_line_prefix().doxygen_newlines('')
 .doxygen_split_long_lines(line_width,'')/][utils_newline()/][/if]
[/template]

[**
 * @brief The template for doxygen documentation of a source file. 
 */]
[template public doxygen_source_doc(aBrief: String)
                             post(doxygen_block())]
[doxygen_file('').doxygen_line_prefix()/]
[doxygen_line_prefix('')/]
[aBrief.doxygen_brief().doxygen_line_prefix()/]
[/template]
